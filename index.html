<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Love Stages üíù (Ultra Smooth Touch)</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700;800&family=Itim&display=swap" rel="stylesheet">
<style>
:root{
  --primary:#ff4d6d; --primary-2:#ff8fa3; --accent:#7c83ff; --accent-2:#60a5fa;
  --ink:#0b1220; --ink-2:#1f2937; --ink-3:#475569;
  --ring:rgba(15,23,42,.14); --glass:rgba(255,255,255,.92);
  --bg1:#1a1533; --bg2:#0b1026;
  --shadow:0 10px 30px rgba(0,0,0,.20); --shadow-lg:0 24px 56px rgba(0,0,0,.32);
}
*{box-sizing:border-box}
html,body{height:100%}
:lang(th){ letter-spacing:0 !important }
body{
  margin:0; font-family:'Kanit',system-ui,Segoe UI,Roboto,Arial,sans-serif; color:var(--ink); line-height:1.75;
  background:
    radial-gradient(900px 500px at 20% -10%, #2a1f3d 0, transparent 60%),
    radial-gradient(900px 500px at 80% -10%, #14213d 0, transparent 60%),
    linear-gradient(180deg, var(--bg1), var(--bg2));
  overflow-x:hidden; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}

/* Layers */
#stars{position:fixed; inset:0; z-index:0; pointer-events:none}
#floatEmo{position:fixed; inset:0; z-index:1; pointer-events:none}
#petsLayer{position:fixed; inset:0; z-index:2; pointer-events:none}
.container{position:relative; z-index:3}
#fxLayer{position:fixed; inset:0; z-index:4; pointer-events:none; contain:layout paint}
#toasts{position:fixed; left:50%; bottom:16px; transform:translateX(-50%); z-index:5; width:min(95vw,560px); display:flex; flex-direction:column; gap:8px}
.modal{position:fixed; inset:0; z-index:40; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.65)}
.modal.open{display:flex}

/* Utilities */
.hidden{display:none !important}
.center{text-align:center}
.small{font-size:.98rem}
.mt-8{margin-top:8px} .mt-12{margin-top:12px} .mt-16{margin-top:16px}
.hand{font-family:'Itim',cursive}

/* UI chrome */
.container{max-width:1100px; margin:0 auto; padding:20px 16px}
header{display:flex; justify-content:center; align-items:center; gap:12px; padding:22px 0; user-select:none}
.brand .logo{font-size:30px; filter:drop-shadow(0 4px 10px rgba(255,77,109,.45))}
.brand .text{color:#fff; font-weight:800; font-size:clamp(18px,3vw,28px); text-shadow:0 1px 0 rgba(255,255,255,.2)}
.progress{position:sticky; top:0; height:7px; background:rgba(255,255,255,.25); border-radius:999px; overflow:hidden}
.progress i{display:block; height:100%; width:0%;
  background:linear-gradient(90deg,#ff4d6d,#ff8fa3,#7c83ff,#60a5fa);
  animation:barGlow 2.8s linear infinite
}
@keyframes barGlow{0%{filter:brightness(1)}50%{filter:brightness(1.2)}100%{filter:brightness(1)}}
.badge{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border:1px solid var(--ring); border-radius:999px; background:#fff; font-weight:800; box-shadow:0 6px 20px rgba(0,0,0,.06)}
#elapsed{position:fixed; left:10px; top:10px; z-index:6}

/* Cards/Buttons */
.card{background:var(--glass); border:1px solid var(--ring); border-radius:22px; box-shadow:var(--shadow); backdrop-filter:saturate(110%) blur(2px); position:relative; transform:translateZ(0)}
.p-24{padding:24px}.p-32{padding:32px}.p-40{padding:40px}
button{appearance:none; border:0; cursor:pointer; font-family:inherit; transition:transform .18s ease, box-shadow .18s ease, filter .18s ease; touch-action:manipulation}
.btn{padding:12px 16px; border-radius:14px; font-weight:800; position:relative; overflow:hidden; isolation:isolate}
.btn::after{content:""; position:absolute; inset:-2px; border-radius:inherit; box-shadow:0 0 0 0 rgba(255,255,255,.0); opacity:0; transition:all .25s ease}
.btn:hover::after{box-shadow:0 0 16px 6px rgba(255,255,255,.35); opacity:1}
.btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-2)); color:#fff; box-shadow:0 10px 26px rgba(255,77,109,.28)}
.btn-ghost{background:#fff; border:1px solid var(--ring); color:var(--ink)}
.btn-accent{background:linear-gradient(135deg,#7c83ff,#6366f1); color:#fff; box-shadow:0 10px 26px rgba(99,102,241,.28)}
.btn:hover{transform:translateY(-1px); filter:saturate(110%)} .btn:active{transform:translateY(1px) scale(.99)}

/* Typography */
.title{font-size:clamp(28px,4vw,48px); color:var(--ink)}
.title.black-shimmer{
  background:linear-gradient(90deg,#111 0%,#111 40%,#444 50%,#111 60%,#111 100%);
  -webkit-background-clip:text; background-clip:text; color:transparent;
  animation:blackShimmer 3.2s linear infinite;
}
.subtitle{font-size:clamp(16px,2.4vw,20px); color:var(--ink-2); line-height:1.9}
.aura{position:relative}
.aura::before{content:""; position:absolute; inset:-8px; border-radius:24px; background:radial-gradient(120px 60px at 20% 20%, rgba(255,77,109,.22), transparent 60%), radial-gradient(120px 60px at 80% 80%, rgba(96,165,250,.18), transparent 60%); filter:blur(14px); z-index:-1; opacity:.7; animation:pulse 3.8s ease-in-out infinite}
@keyframes pulse{0%{transform:scale(1); opacity:.55}50%{transform:scale(1.03); opacity:.9}100%{transform:scale(1); opacity:.55}}
.jiggle{display:inline-block; animation:jiggle 2.8s ease-in-out infinite}
@keyframes jiggle{0%,100%{transform:translateY(0)}10%{transform:translateY(-1px)}20%{transform:translateY(1px)}}

/* Stage virtualization */
.stage{display:none; opacity:0; transform:translateY(10px); content-visibility:auto; contain-intrinsic-size:600px}
.stage.active{display:block; animation:stageIn .45s cubic-bezier(.18,.72,.22,1) forwards}
@keyframes stageIn{from{opacity:0; transform:translateY(10px) scale(.985)} to{opacity:1; transform:translateY(0) scale(1)}}
.stage:not(.active){pointer-events:none}

/* Toast */
.toast{background:#fff; border:1px solid var(--ring); border-radius:12px; padding:12px 14px; box-shadow:var(--shadow); opacity:0; transform:translateY(6px); transition:all .2s ease; font-weight:800}
.toast.show{opacity:1; transform:translateY(0)}
.toast.ok{background:#ecfdf5} .toast.warn{background:#fff7ed} .toast.err{background:#fef2f2}

/* Boards & Quiz */
.board{display:grid; grid-template-columns:repeat(5, minmax(0,1fr)); gap:12px}
@media (max-width:620px){ .board{grid-template-columns:repeat(4, minmax(0,1fr))} }
@media (max-width:420px){ .board{grid-template-columns:repeat(3, minmax(0,1fr))} }
.tile{aspect-ratio:1/1; border-radius:18px; border:1px solid var(--ring); background:#fff; position:relative; overflow:hidden; will-change:transform}
.tile>span{position:absolute; inset:0; display:grid; place-items:center; font-size:24px}
.tile.found{background:linear-gradient(135deg,var(--primary),#ff9ab1); color:#fff}
.grid-match{display:grid; grid-template-columns:repeat(6, minmax(0,1fr)); gap:12px}
@media (max-width:880px){ .grid-match{grid-template-columns:repeat(4, minmax(0,1fr))} }
@media (max-width:520px){ .grid-match{grid-template-columns:repeat(3, minmax(0,1fr))} }
.card-m{aspect-ratio:3/4; border-radius:16px; position:relative; perspective:900px; cursor:pointer; will-change:transform}
.card-face{position:absolute; inset:0; border-radius:16px; display:grid; place-items:center; font-size:28px; backface-visibility:hidden; border:1px solid var(--ring)}
.card-front{background:#fff} .card-back{background:#fff; transform:rotateY(180deg)}
.card-m.flip .card-front{transform:rotateY(180deg)} .card-m.flip .card-back{transform:rotateY(360deg)}
.card-m.matched .card-back{background:linear-gradient(135deg,var(--primary),#ff9ab1); color:#fff}
.quiz{display:grid; gap:16px}
.q{background:#fff; border:1px solid var(--ring); border-radius:16px; padding:16px}
.q h4{margin:0 0 8px 0; color:#111}
.opt{display:flex; flex-wrap:wrap; gap:8px}
.opt button{border:1px solid var(--ring); background:#fff; color:#111; border-radius:12px; padding:8px 12px; font-weight:700}
.opt button.selected{background:linear-gradient(135deg,#111,#333); color:#fff; border-color:transparent}

/* Envelope */
.letterbox{width:min(92vw,520px); background:#fff; border-radius:18px; border:1px solid var(--ring); box-shadow:var(--shadow-lg); overflow:hidden}
.letter-flap{height:110px; background:linear-gradient(135deg,#ffd6e1,#fff); transform-origin:top; animation:flapOpen .7s ease forwards}
@keyframes flapOpen{0%{transform:rotateX(0)}100%{transform:rotateX(180deg)}}
.letter-paper{padding:18px 18px 24px; transform:translateY(-60px); animation:paperOut .7s .2s ease forwards; opacity:0}
@keyframes paperOut{to{transform:translateY(0); opacity:1}}

/* Balloon Area (rAF) */
#balloonArea{position:relative; height:540px; overflow:hidden; border:1px dashed var(--ring); border-radius:16px; background:linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.78))}
.balloonWrap{position:absolute; will-change:transform}
.balloon{position:absolute; left:50%; transform:translate(-50%,-50%); width:54px; height:68px; cursor:pointer; border-radius:50% 50% 45% 45%; --balloon:#ff6b81;
  background: radial-gradient(40% 40% at 30% 28%, rgba(255,255,255,.65), rgba(255,255,255,0) 60%), linear-gradient(180deg, var(--balloon), rgba(0,0,0,.06));
  border:2px solid rgba(0,0,0,.08); box-shadow:0 8px 16px rgba(0,0,0,.12)}
.balloon::after{content:""; position:absolute; left:50%; transform:translateX(-50%); bottom:-24px; width:2px; height:28px; background:rgba(0,0,0,.18); border-radius:2px}

/* Floating Emoji */
.emo{position:absolute; top:100vh; opacity:.18; filter:drop-shadow(0 1px 0 rgba(255,255,255,.3)); will-change:transform,opacity; pointer-events:none}
@keyframes floatUp { from { transform: translateY(10vh) translateX(var(--dx,0)); opacity:.12;} to { transform: translateY(-120vh) translateX(calc(var(--dx,0) * 1.8)); opacity:.22;} }
</style>
</head>
<body>
<canvas id="stars"></canvas>
<div id="floatEmo" aria-hidden="true"></div>
<div id="petsLayer" aria-hidden="true"></div>

<!-- ‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏´‡∏±‡∏ß‡πÉ‡∏à/‡∏£‡∏¥‡∏õ‡πÄ‡∏õ‡∏¥‡∏•) ‡πÉ‡∏ä‡πâ pool -->
<div id="fxLayer"></div>

<div id="toasts" aria-live="polite"></div>
<div id="elapsed" class="badge">‚è≥ ‡∏Ñ‡∏ö‡∏Å‡∏±‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß: <b id="elapsedTxt">--</b></div>

<div class="container">
  <header class="nav">
    <div class="brand aura"><div class="logo">üíù</div><div class="text"><span class="jiggle">Love Stages</span> ‚Äî Just for You</div></div>
  </header>
  <div class="progress"><i id="bar"></i></div>

  <!-- Gate -->
  <section id="stage-gate" class="stage active">
    <div class="card p-40 center aura">
      <h1 class="title black-shimmer">Anniversary For Por Love</h1>
      <p class="subtitle mt-12" id="gateMsg"></p>
      <div class="mt-16" style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <input id="gateInput" inputmode="none" readonly placeholder="‡∏ß‡∏±‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏™‡∏≠‡∏á‡∏Ñ‡∏ô üíû"
               style="padding:14px;border-radius:14px;border:1px solid var(--ring);min-width:260px;background:#fff;color:var(--ink);font-weight:800;caret-color:transparent"/>
        <button id="gateBtn" class="btn btn-primary">‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å</button>
      </div>
      <div id="keypad" class="mt-12" style="display:grid;grid-template-columns:repeat(3,62px);gap:8px;justify-content:center">
        <button class="btn btn-ghost k">1</button><button class="btn btn-ghost k">2</button><button class="btn btn-ghost k">3</button>
        <button class="btn btn-ghost k">4</button><button class="btn btn-ghost k">5</button><button class="btn btn-ghost k">6</button>
        <button class="btn btn-ghost k">7</button><button class="btn btn-ghost k">8</button><button class="btn btn-ghost k">9</button>
        <button class="btn btn-ghost k">/</button><button class="btn btn-ghost k">0</button><button class="btn btn-ghost k">‚å´</button>
        <button id="keyEnter" class="btn btn-accent" style="grid-column:1/4">‡∏ï‡∏Å‡∏•‡∏á</button>
      </div>
      <div id="gateErr" class="mt-12 small" style="color:#ef4444;font-weight:800"></div>
      <div id="annivInfo" class="mt-12 small"></div>
    </div>
  </section>

  <!-- Story A -->
  <section id="stage-story-a" class="stage">
    <div class="card p-40 center aura">
      <h2 class="title" style="color:#111">‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1 ‚Äî <span class="jiggle">‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô‡∏î‡∏µ‡∏ô‡πâ‡∏≤</span> ‚ú®</h2>
      <p class="subtitle mt-12" id="storyAtext"></p>
      <div class="mt-16" style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <button class="btn btn-ghost miniA" data-correct="1">üèùÔ∏è ‡πÄ‡∏Å‡∏≤‡∏∞‡∏•‡πâ‡∏≤‡∏ô</button>
        <button class="btn btn-ghost miniA" data-correct="0">‚òï ‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á</button>
        <button class="btn btn-ghost miniA" data-correct="0">üé¢ ‡∏™‡∏ß‡∏ô‡∏™‡∏ô‡∏∏‡∏Å</button>
      </div>
      <div class="mt-12 small hintA hidden">üí° ‡πÉ‡∏ö‡πâ: ‡πÄ‡∏Å‡∏≤‡∏∞ + ‡∏ô‡πâ‡∏≥‡∏ó‡∏∞‡πÄ‡∏•‡πÉ‡∏™</div>
      <div id="countdownA" class="small mt-12" style="font-weight:800;color:var(--ink-3)"></div>
      <div id="quoteA" class="small mt-8"></div>
    </div>
  </section>

  <!-- Stage 1 -->
  <section id="stage-1" class="stage">
    <div class="card p-40 aura">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <h3 style="font-size:clamp(18px,2.5vw,26px);font-weight:800;color:var(--ink)">‡∏î‡πà‡∏≤‡∏ô 1: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏±‡∏ß‡πÉ‡∏à üíñ</h3>
        <div id="score1" class="badge">Found: 0/7</div>
      </div>
      <p class="small mt-8">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏≤ üíñ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö</p>
      <div id="board1" class="board mt-16"></div>
      <div id="countdown1" class="small mt-12" style="font-weight:800;color:var(--ink-3)"></div>
    </div>
  </section>

  <!-- Story B -->
  <section id="stage-story-b" class="stage">
    <div class="card p-40 center aura">
      <h2 class="title" style="color:#111">‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2 ‚Äî <span class="jiggle">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡πÉ‡∏à</span> üí≠</h2>
      <p id="storyBtext" class="subtitle mt-12"></p>
      <div class="mt-16" style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
        <button class="btn btn-accent miniB-yes" data-correct="1">üíñ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
        <button class="btn btn-ghost miniB-no" data-correct="0">üí¨ ‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
      </div>
      <div class="mt-12 small hintB hidden">‡πÄ‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡πà‡∏≤‡πÄ‡∏ò‡∏≠‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡πâ‡∏≤.... üíó</div>
      <div id="countdownB" class="small mt-12" style="font-weight:800;color:var(--ink-3)"></div>
      <div id="quoteB" class="small mt-8"></div>
    </div>
  </section>

  <!-- Stage 2 -->
  <section id="stage-2" class="stage">
    <div class="card p-40 aura">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <h3 style="font-size:clamp(18px,2.5vw,26px);font-weight:800;color:var(--ink)">‡∏î‡πà‡∏≤‡∏ô 2: Memory Match ‚ú®</h3>
        <div id="score2" class="badge">Matched: 0/6</div>
      </div>
      <p class="small mt-8">‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö</p>
      <div id="gridMatch" class="grid-match mt-16"></div>
      <div id="countdown2" class="small mt-12" style="font-weight:800;color:var(--ink-3)"></div>
    </div>
  </section>

  <!-- Story C -->
  <section id="stage-story-c" class="stage">
    <div class="card p-40 center aura">
      <h2 class="title" style="color:#111">‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3 ‚Äî <span class="jiggle">‡∏≠‡∏¢‡∏≤‡∏Å‡∏ö‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ</span> üí´</h2>
      <p id="storyCtext" class="subtitle mt-12"></p>
      <div class="mt-16" style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <input id="answerC" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏ò‡∏≠‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà"
               style="padding:14px;border-radius:14px;border:1px solid var(--ring);min-width:260px;background:#fff;color:var(--ink);font-weight:700"/>
        <button id="answerCBtn" class="btn btn-primary">üíù ‡∏ï‡∏≠‡∏ö</button>
      </div>
      <div class="mt-12 small hintC hidden">‡πÉ‡∏ö‡πâ: ‚Äú‡πÄ‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡∏±‡∏ö‡πÄ‡∏ò‡∏≠...‡∏ô‡πâ‡∏≤‚Äù</div>
      <div id="countdownC" class="small mt-12" style="font-weight:800;color:var(--ink-3)"></div>
      <div id="quoteC" class="small mt-8"></div>
    </div>
  </section>

  <!-- Stage 3 -->
  <section id="stage-3" class="stage">
    <div class="card p-40 aura">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <h3 style="font-size:clamp(18px,2.5vw,26px);font-weight:800;color:var(--ink)">‡∏î‡πà‡∏≤‡∏ô 3: Quiz of Love ü•∞</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <div class="badge">‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö: <b id="needQ">0</b> ‡∏Ç‡πâ‡∏≠</div>
          <div id="score3" class="badge">Correct: 0/0</div>
        </div>
      </div>
      <div class="small mt-8">‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
      <div id="quiz" class="quiz mt-16"></div>
      <div id="countdown3" class="small mt-12" style="font-weight:800;color:var(--ink-3)"></div>
    </div>
  </section>

  <!-- Stage 4 Balloon -->
  <section id="stage-4" class="stage">
    <div class="card p-40 aura">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <h3 style="font-size:clamp(18px,2.5vw,26px);font-weight:800;color:var(--ink)">‡∏î‡πà‡∏≤‡∏ô 4: Balloon Pop üéà</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <div class="badge">üéØ ‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏¥‡πâ‡∏°: <b id="needB">18</b></div>
          <div class="badge">üí• ‡∏à‡∏¥‡πâ‡∏°‡πÅ‡∏•‡πâ‡∏ß: <b id="hitB">0</b></div>
          <div class="badge">‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤: <b id="timeB">30</b>s</div>
        </div>
      </div>
      <div id="balloonArea" class="mt-16"></div>
      <div id="countdownBdone" class="small mt-12" style="font-weight:800;color:var(--ink-3)"></div>
      <div class="mt-16" style="display:flex;gap:10px;flex-wrap:wrap">
        <button id="startB" class="btn btn-accent">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô!</button>
        <button id="resetB" class="btn btn-ghost" disabled>üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</button>
        <button id="nextB" class="btn btn-primary hidden">‡πÑ‡∏õ‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏û‡∏£‡∏™‡πå‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ‚ûú</button>
      </div>
    </div>
  </section>

  <!-- Final -->
  <section id="stage-final" class="stage">
    <div class="card p-40 aura">
      <h2 class="title" style="color:#111">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ò‡∏≠, üíñ</h2>
      <p id="finalLead" class="subtitle mt-12 hand">‡πÄ‡∏ò‡∏≠‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏°‡∏≤‡∏Å ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å‡πÜ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ ‡∏à‡∏∏‡πä‡∏ö‡∏°‡∏ß‡∏±‡πä‡∏∞‡∏∞‡∏∞...üíñ</p>
      <div class="mt-16" style="display:flex;gap:14px;flex-wrap:wrap;align-items:flex-start">
        <div class="card p-24 aura" style="flex:1;min-width:280px">
          <h3 style="font-weight:800;color:var(--ink)">‡∏ã‡∏≠‡∏á‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏•‡∏±‡∏ö...‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏Å üíå</h3>
          <div id="envelope" class="mt-12" style="width:260px;height:180px;margin:0 auto;cursor:pointer;position:relative">
            <div style="position:absolute;inset:0;background:#fff;border:1px solid var(--ring);border-radius:12px"></div>
            <div style="position:absolute;top:0;left:0;right:0;height:60%;background:linear-gradient(135deg,#ffe0e7,#fff);border-top-left-radius:12px;border-top-right-radius:12px;border:1px solid var(--ring);border-bottom:none"></div>
          </div>
          <p class="small center mt-8">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢</p>
        </div>
        <div class="card p-24 aura" style="flex:1;min-width:280px">
          <h3 style="font-weight:800;color:var(--ink)">‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç üéÅ</h3>
          <div class="center"><button id="giftBtn" class="btn btn-accent">‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç!</button></div>
          <p id="giftMsg" class="small center mt-8">‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏°‡∏µ‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏û‡∏£‡∏™‡πå...‡∏°‡∏±‡πâ‡∏á </p>
        </div>
        <div class="card p-24 aura" style="flex:1;min-width:280px">
          <h3 style="font-weight:800;color:var(--ink)">‡∏™‡∏∏‡πà‡∏°‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡πâ‡∏≤‡∏ó‡∏≥ üéüÔ∏è</h3>
          <div id="couponRoll" class="mt-12" style="height:54px;display:grid;place-items:center;border:1px dashed var(--ring);border-radius:12px;background:#fff;font-weight:800">‡∏Å‡∏î ‚Äú‡∏™‡∏∏‡πà‡∏°!‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏∏‡πâ‡∏ô</div>
          <button id="couponBtn" class="btn btn-accent mt-12">üé≤ ‡∏™‡∏∏‡πà‡∏°!</button>
        </div>
      </div>
      <div class="mt-16" style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
        <button id="burstFinal" class="btn btn-primary">‡∏™‡πà‡∏á‡∏´‡∏±‡∏ß‡πÉ‡∏à‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡πâ‡∏≤‡∏´‡∏ô‡πà‡∏≠‡∏¢</button>
        <button id="copyLink" class="btn btn-ghost">üìã ‡πÅ‡∏ä‡∏£‡πå/‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå</button>
      </div>
      <div class="badge mt-16">üóìÔ∏è ‡∏ô‡∏±‡∏ö‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á ‚Äú‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏£‡∏≠‡∏ö‚Äù ( ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 25 ‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ): <b id="annivCountdown">-</b></div>
    </div>
     <p class="small center mt-16">I Love you Por ‚ù§Ô∏è</p>
  </section>
</div>

<!-- Envelope Modal -->
<div id="envModal" class="modal" role="dialog" aria-modal="true" aria-label="‡∏à‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡πâ‡∏≤">
  <div class="letterbox">
    <div class="letter-flap"></div>
    <div class="letter-paper">
      <h3 class="hand" style="margin:0 0 8px 0">‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡πâ‡∏≤ üíå</h3>
      <p id="letterText" class="hand" style="margin:0">
        ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ò‡∏≠‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏°‡∏µ‡∏ó‡∏∞‡πÄ‡∏•‡∏≤‡∏∞‡∏Å‡∏±‡∏ô‡∏ö‡πâ‡∏≤‡∏á ‡πÇ‡∏Å‡∏£‡∏ò‡∏Å‡∏±‡∏ô‡∏ö‡πâ‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏≠‡∏ö‡∏ó‡∏≥‡πÉ‡∏ô‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πà‡∏≤‡∏á‡∏Ñ‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏≠‡∏ö‡∏Å‡∏±‡∏ô
        ‡πÅ‡∏ï‡πà‡πÄ‡∏Ñ‡πâ‡∏≤‡∏Å‡πá‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏î‡∏µ‡πÉ‡∏à ‡πÅ‡∏•‡∏∞‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô‡πÉ‡∏à ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏°‡∏µ‡πÄ‡∏ò‡∏≠‡∏Ñ‡∏≠‡∏¢‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡πâ‡∏≤ ‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô ‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à‡∏Å‡∏±‡∏ô ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ã‡∏ü‡πÇ‡∏ã‡∏ô‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ô
        ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏Å‡πÜ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡πâ‡∏≤‡∏ä‡∏≠‡∏ö‡∏ó‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏¥‡∏™‡∏±‡∏¢‡πÑ‡∏°‡πà‡∏î‡∏µ ‡∏î‡∏∑‡πâ‡∏≠ ‡πÄ‡∏≠‡∏≤‡πÅ‡∏ï‡πà‡πÉ‡∏à‡∏Å‡∏±‡∏ö‡πÄ‡∏ò‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏•‡∏≠‡∏î 
        ‡πÅ‡∏•‡∏∞‡∏Å‡πá‡∏ä‡∏≠‡∏ö‡∏Ç‡∏µ‡πâ‡∏õ‡∏£‡∏∞‡∏ä‡∏î ‡∏ä‡∏≠‡∏ö‡πÇ‡∏Å‡∏´‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ö‡πà‡∏≠‡∏¢‡πÜ ‡πÉ‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡πÜ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏ó‡∏µ‡πà‡∏ä‡∏≠‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏ò‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏ö‡∏≤‡∏¢‡πÉ‡∏à‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏•‡∏≠‡∏î
        ‡πÅ‡∏ï‡πà‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏ô‡∏±‡πâ‡∏ô ‡πÄ‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ ‡∏Å‡πá‡∏£‡∏±‡∏Å‡πÄ‡∏ò‡∏≠‡∏°‡∏≤‡∏Å‡πÜ‡∏ô‡∏∞ ‡∏£‡∏±‡∏Å‡πÄ‡∏ò‡∏≠‡∏´‡∏°‡∏î‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏Å‡πÄ‡∏ò‡∏≠‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏û‡∏π‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÑ‡∏î‡πâ‡∏≠‡∏∞
        ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏á‡∏±‡πâ‡∏ô ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ ‡∏≠‡∏¢‡πà‡∏≤‡πÑ‡∏õ‡πÑ‡∏´‡∏ô‡∏≠‡∏µ‡∏Å‡πÄ‡∏•‡∏¢‡∏ô‡∏∞ ‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡∏à‡∏ô‡πÅ‡∏Å‡πà‡πÑ‡∏õ‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞...ü©∑üë©‚Äç‚ù§Ô∏è‚Äçüë®
      </p>
    </div>
  </div>
  <button id="closeEnv" class="btn btn-ghost" style="position:absolute;top:16px;right:16px">‚úï ‡∏õ‡∏¥‡∏î</button>
</div>

<script>
/* ====================== SETTINGS ====================== */
const SETTINGS = {
  secretAnniv: "25042024",
  anniversaryDate: "2024-04-25",
  monthlyDay: 25,
  storyA: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡∏û‡∏≤‡πÄ‡∏ò‡∏≠‡πÑ‡∏õ‡πÄ‡∏î‡∏ó‡∏Ñ‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô?",
  storyB: "‡∏ñ‡πâ‡∏≤‡∏¢‡πâ‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‚Ä¶‡πÄ‡∏ò‡∏≠‡∏à‡∏∞ ‚Äú‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‚Äù ‡πÄ‡∏Ñ‡πâ‡∏≤‡πÑ‡∏´‡∏° ü•∫",
  storyC: "‡πÇ‡∏ï‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏∞‡πÑ‡∏£?",
  quotesA: ["‡πÄ‡∏ò‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡πâ‡∏≤ ‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å‡πÜ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÄ‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏Å‡∏°‡∏∞‡∏°‡∏¥‡πä‡∏ô‡∏∞‡∏Ñ‡∏∞ üíó"],
  quotesB: ["‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á ‡πÜ ‡∏Å‡∏±‡∏ô ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏ï‡∏•‡∏≠‡∏î‡πÑ‡∏õ‡∏ô‡∏∞ üíñ"],
  quotesC: ["‡πÄ‡∏Ñ‡πâ‡∏≤‡∏î‡∏µ‡πÉ‡∏à‡∏ô‡∏∞‡∏Ñ‡∏∞ ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏°‡∏∞‡∏°‡∏¥‡πä‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡πâ‡∏≤‡∏á‡πÜ‡πÄ‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ ‡∏à‡∏∏‡πä‡∏ö üíù"],
  quiz: [
    { q:"‡πÄ‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡∏Å‡πÑ‡∏õ‡∏´‡∏≤‡πÄ‡∏ò‡∏≠‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏ô?", a:["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1","‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 2","‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 3"], correct:0 },
    { q:"‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÅ‡∏ï‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏ò‡∏≠?", a:["üèñÔ∏è ‡∏ä‡∏≤‡∏¢‡∏´‡∏≤‡∏î","‚õ∞Ô∏è ‡∏ö‡∏ô‡∏†‡∏π‡πÄ‡∏Ç‡∏≤","üå∫ ‡πÉ‡∏ô‡∏™‡∏ß‡∏ô‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ"], correct:0 },
    { q:"‡πÄ‡∏Ñ‡πâ‡∏≤‡∏ä‡∏≠‡∏ö‡πÑ‡∏õ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô?", a:["üèîÔ∏è ‡∏†‡∏π‡πÄ‡∏Ç‡∏≤","üåä ‡∏ó‡∏∞‡πÄ‡∏•","üåç ‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®"], correct:0 }
  ],
  floatEmojis: ["üíñ","üíï","üíó","‚ú®","‚≠ê","üåü","üí´"],
  pets: [
    {name:"‡∏°‡∏≠‡∏°‡πÅ‡∏°‡∏°", emoji:"üê∂", color:"#b45309"},
    {name:"‡∏î‡∏∏‡πä‡∏Å‡∏î‡∏¥‡πä‡∏Å", emoji:"üê∂", color:"#92400e"},
    {name:"‡∏ô‡∏°‡∏à‡∏∑‡∏î", emoji:"üê±", color:"#334155"}
  ],
  balloon: { need:18, time:30, spawnEveryMs:480, minDur:7.0, maxDur:11.0 }, // ‡∏•‡∏≠‡∏¢‡∏à‡∏≤‡∏Å‡∏•‡πà‡∏≤‡∏á‡∏ñ‡∏∂‡∏á‡∏ö‡∏ô
  fx: { poolHearts: 40, poolRipples: 14 } // ‡∏á‡∏ö‡∏û‡∏≤‡∏£‡πå‡∏ï‡∏¥‡πÄ‡∏Ñ‡∏¥‡∏•‡∏£‡∏ß‡∏° (‡∏•‡∏∑‡πà‡∏ô‡πÅ‡∏°‡πâ‡∏Å‡∏î‡∏£‡∏±‡∏ß)
};

/* =================== Utils & Core Flow =================== */
const $ = (id)=>document.getElementById(id);
const STAGES = ["stage-gate","stage-story-a","stage-1","stage-story-b","stage-2","stage-story-c","stage-3","stage-4","stage-final"];
let CURRENT_STAGE = "stage-gate";

function showStage(id){
  document.querySelectorAll(".stage").forEach(s=>{ s.classList.remove("active"); s.style.display="none"; });
  const el=document.getElementById(id); if(!el) return;
  el.style.display="block"; void el.offsetHeight; el.classList.add("active");
  const bar=$("bar"); if(bar){ bar.style.width = (STAGES.indexOf(id)/(STAGES.length-1))*100 + "%"; }
  history.replaceState(null,"","#"+id);
  CURRENT_STAGE = id;
  FX.setMode(id==="stage-4" ? "light" : "normal"); // ‡∏î‡πà‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡πÇ‡∏õ‡πà‡∏á‡∏•‡∏î‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå global
  scrollTo({top:0,behavior:"smooth"});
}

/* ================= Particle FX (‡∏´‡∏±‡∏ß‡πÉ‡∏à/‡∏£‡∏¥‡∏õ‡πÄ‡∏õ‡∏¥‡∏•) ‚Äî Single RAF + Pool ================= */
const FX = (function(){
  const layer = $("fxLayer");
  const maxHearts = SETTINGS.fx.poolHearts;
  const maxRipples = SETTINGS.fx.poolRipples;
  const hearts = []; const ripples = [];
  let raf = null, last = performance.now(), mode = "normal";
  let tapTimes = []; // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏î‡∏£‡∏±‡∏ß‡∏°‡∏≤‡∏Å

  for(let i=0;i<maxHearts;i++){
    const el = document.createElement("span");
    el.textContent = ["üíñ","üíï","üíó","‚ú®","‚≠ê"][i%5];
    el.style.position="absolute"; el.style.willChange="transform,opacity"; el.style.opacity="0"; el.style.filter="drop-shadow(0 2px 4px rgba(0,0,0,.15))";
    layer.appendChild(el);
    hearts.push({el,alive:false,x:0,y:0,vx:0,vy:0,life:0,ttl:0,scale:1});
  }
  for(let i=0;i<maxRipples;i++){
    const el = document.createElement("div");
    el.style.position="absolute"; el.style.border="2px solid rgba(255,255,255,.9)"; el.style.borderRadius="999px";
    el.style.width="14px"; el.style.height="14px"; el.style.opacity="0"; el.style.willChange="transform,opacity"; el.style.mixBlendMode="screen";
    layer.appendChild(el);
    ripples.push({el,alive:false,x:0,y:0,life:0,ttl:0,scale:1});
  }

  function spawnHeart(x,y,count=8){
    const now=performance.now(); tapTimes.push(now);
    // ‡∏ï‡∏±‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡∏ß‡πà‡∏≤ 350ms
    while(tapTimes.length && now - tapTimes[0] > 350) tapTimes.shift();
    if(tapTimes.length>=6) setMode("light-temporary");

    const usable = mode==="off" ? 0 : (mode==="light"||mode==="light-temporary" ? Math.ceil(count*0.4) : count);
    for(let i=0;i<usable;i++){
      const h = hearts.find(o=>!o.alive); if(!h) break;
      const ang = (Math.PI*2)*(i/usable) + (Math.random()*0.6-0.3);
      const speed = 160 + Math.random()*140;
      const ttl = 600 + Math.random()*500;
      const s = (mode==="light"||mode==="light-temporary") ? (12+Math.random()*6) : (14+Math.random()*16);
      h.alive=true; h.x=x; h.y=y; h.vx=Math.cos(ang)*speed; h.vy=Math.sin(ang)*speed*0.8; h.life=0; h.ttl=ttl; h.scale=s/16;
      h.el.style.fontSize = s+"px";
      h.el.style.opacity="1";
      h.el.style.transform = `translate(${x}px,${y}px) scale(1)`;
    }
  }
  function spawnRipple(x,y){
    if(mode==="off") return;
    const r = ripples.find(o=>!o.alive); if(!r) return;
    const ttl = 420;
    r.alive=true; r.x=x; r.y=y; r.life=0; r.ttl=ttl; r.scale=1;
    r.el.style.opacity="0.9";
    r.el.style.transform=`translate(${x}px,${y}px) scale(1) translate(-50%,-50%)`;
  }

  function loop(t){
    const dt = Math.min(48, t - last); last = t;

    // hearts
    for(const h of hearts){
      if(!h.alive) continue;
      h.life += dt; const p = h.life / h.ttl;
      h.x += h.vx * (dt/1000); h.y += h.vy * (dt/1000);
      const fade = 1 - p;
      h.el.style.opacity = fade<=0? "0" : String(fade);
      h.el.style.transform = `translate(${h.x}px,${h.y}px) scale(${h.scale*(1 - p*0.3)})`;
      if(p>=1){ h.alive=false; }
    }
    // ripples
    for(const r of ripples){
      if(!r.alive) continue;
      r.life += dt; const p=r.life/r.ttl;
      const s = 1 + p*22;
      r.el.style.opacity = String(0.8*(1-p));
      r.el.style.transform = `translate(${r.x}px,${r.y}px) translate(-50%,-50%) scale(${s})`;
      if(p>=1){ r.alive=false; r.el.style.opacity="0"; }
    }

    if(mode==="light-temporary"){
      // ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà normal ‡∏´‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≤‡∏ô 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏Å‡∏î‡∏£‡∏±‡∏ß
      if(!tapTimes.length || performance.now()-tapTimes[tapTimes.length-1] > 1000){
        setMode(CURRENT_STAGE==="stage-4" ? "light" : "normal");
      }
    }
    raf = requestAnimationFrame(loop);
  }
  raf = requestAnimationFrame(loop);

  function setMode(m){
    mode = m;
  }
  return {
    emit(x,y,hearts=10){ spawnHeart(x,y,hearts); spawnRipple(x,y); },
    tiny(x,y){ spawnHeart(x,y,4); }, // ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ö‡∏≤
    ripple(x,y){ spawnRipple(x,y); },
    setMode
  };
})();

/* ===== Global light FX on tap (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏î‡πà‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡πÇ‡∏õ‡πà‡∏á) ===== */
addEventListener("pointerdown",(e)=>{
  if(CURRENT_STAGE==="stage-4") return; // ‡∏á‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏≠‡∏•‡∏•‡∏π‡∏ô
  FX.emit(e.clientX,e.clientY,10);
},{passive:true});

/* ================= Visual layers ================= */
(function stars(){ const c=document.createElement("canvas"); c.id="stars"; const old=$("stars"); old.replaceWith(c);
  const ctx=c.getContext("2d"); let w,h,stars=[];
  function resize(){ w=c.width=innerWidth; h=c.height=innerHeight; } addEventListener("resize",resize,{passive:true}); resize();
  stars=Array.from({length:140},()=>({x:Math.random()*w,y:Math.random()*h,r:Math.random()*1.2+0.3,a:Math.random()*0.6+0.3,tw:Math.random()*0.02+0.005}));
  (function step(){ ctx.clearRect(0,0,w,h); ctx.fillStyle="#fff";
    for(const s of stars){ s.a+=s.tw; ctx.globalAlpha=0.28+0.35*Math.sin(s.a); ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,6.283); ctx.fill(); }
    ctx.globalAlpha=1; requestAnimationFrame(step);
  })();
})();
(function cssEmos(){
  const layer=$("floatEmo"); if(!layer) return; const COUNT=18;
  for(let i=0;i<COUNT;i++){
    const el=document.createElement("div"); el.className="emo";
    el.textContent=SETTINGS.floatEmojis[Math.floor(Math.random()*SETTINGS.floatEmojis.length)];
    const x = Math.random()*90+5; const dx = (Math.random()<0.5?-1:1)*(20+Math.random()*60);
    const dur = (18+Math.random()*12)+"s"; const delay = (Math.random()*10)+"s";
    el.style.left = x+"vw"; el.style.setProperty("--dx", dx+"px"); el.style.animation = `floatUp ${dur} linear ${delay} infinite`;
    layer.appendChild(el);
  }
})();
(function pets(){
  const layer=$("petsLayer"); if(!layer) return;
  const PETS=SETTINGS.pets.map(p=>({
    ...p, x:Math.random()*innerWidth*0.9+20, y:innerHeight*0.72 + Math.random()*60,
    vx:(Math.random()<0.5?-1:1)*(0.9+Math.random()*0.6), vy:-0.25, rest:0, goalX:null
  }));
  const els=PETS.map(p=>{ const d=document.createElement("div"); d.style.position="absolute"; d.style.fontSize="28px"; d.style.color=p.color; d.textContent=p.emoji; layer.appendChild(d); return d; });
  function loop(){
    for(let i=0;i<PETS.length;i++){
      const p=PETS[i], d=els[i];
      if(p.rest>0){ p.rest--; }
      else{
        if(p.goalX===null && Math.random()<0.012) p.goalX=Math.random()*innerWidth*0.9+20;
        if(p.goalX!=null){ p.vx=Math.sign(p.goalX-p.x)*(1.0+Math.random()*0.7); if(Math.abs(p.goalX-p.x)<8){ p.goalX=null; p.rest=20; } }
        p.x+=p.vx*(1+Math.random()*0.10); p.y+=p.vy;
        if(p.x<6||p.x>innerWidth-40){ p.vx*=-1; p.x=Math.min(Math.max(p.x,6),innerWidth-40); }
        if(p.y<innerHeight*0.68) p.vy=0.30; if(p.y>innerHeight-60) p.vy=-0.30;
        if(Math.random()<0.006) { const o=p.vy; p.vy=-1.0; setTimeout(()=>p.vy=o,380); }
      }
      d.style.transform=`translate(${p.x}px,${p.y}px)`;
    }
    requestAnimationFrame(loop);
  }
  loop();
})();

/* =================== Time widgets =================== */
(function timeWidgets(){
  const out=$("elapsedTxt"); if(!out) return;
  function diffStr(){
    const start=new Date(SETTINGS.anniversaryDate+'T00:00:00'); const now=new Date();
    let y=now.getFullYear()-start.getFullYear(); let mo=now.getMonth()-start.getMonth(); let d=now.getDate()-start.getDate();
    let h=now.getHours()-start.getHours(), mi=now.getMinutes()-start.getMinutes(), s=now.getSeconds()-start.getSeconds();
    if(s<0){ s+=60; mi--; } if(mi<0){ mi+=60; h--; } if(h<0){ h+=24; d--; }
    if(d<0){ const prev=new Date(now.getFullYear(), now.getMonth(), 0).getDate(); d+=prev; mo--; } if(mo<0){ mo+=12; y--; }
    return `${y} ‡∏õ‡∏µ ${mo} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${d} ‡∏ß‡∏±‡∏ô ${String(h).padStart(2,'0')}:${String(mi).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }
  function nextMonthly(day){ const now=new Date(); let y=now.getFullYear(), m=now.getMonth(); let t=new Date(y,m,day,0,0,0); if(t<=now) t=new Date(y,m+1,day,0,0,0); return t; }
  function countdownMonthly(){ const now=new Date(), tgt=nextMonthly(SETTINGS.monthlyDay); const ms=tgt-now, d=Math.floor(ms/86400000), h=Math.floor(ms/3600000)%24, m=Math.floor(ms/60000)%60, s=Math.floor(ms/1000)%60; const el=$("annivCountdown"); if(el) el.textContent=`${d} ‡∏ß‡∏±‡∏ô ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
  setInterval(()=>{ out.textContent = diffStr(); },1000); out.textContent = diffStr();
  setInterval(countdownMonthly,1000); countdownMonthly();
})();

/* =================== Toast =================== */
const toasts=$("toasts");
function toast(msg,type="info",ttl=3200){
  const t=document.createElement("div"); t.className=`toast ${type}`; t.textContent=msg; toasts.appendChild(t);
  requestAnimationFrame(()=>t.classList.add("show"));
  const timer=setTimeout(()=>{ t.classList.remove("show"); setTimeout(()=>t.remove(),250); }, ttl);
  t.addEventListener("click", ()=>{ clearTimeout(timer); t.remove(); });
}

/* =================== Gate =================== */
(function gate(){
  $("gateMsg").textContent = `‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏•‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤..‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏° ( ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${SETTINGS.monthlyDay} ‡∏Ñ‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏ô‡πâ‡∏≤ )`;
  $("annivInfo").textContent = "‡∏Ç‡∏≠‡πÉ‡∏´‡πâ ‡∏™‡∏ô‡∏∏‡∏Å ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç ‡∏ô‡∏∞‡∏Ñ‡∏∞ üíû";
  const input=$("gateInput"), btn=$("gateBtn"), keypad=$("keypad"), keyEnter=$("keyEnter"), err=$("gateErr");
  const SECRET = normalize(SETTINGS.secretAnniv);
  let tries=0, lockUntil=0, lastKeyAt=0;
  function normalize(s){
    s=(s||"").trim();
    const m=s.match(/(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{4})/);
    if(m) return m[1].padStart(2,'0')+m[2].padStart(2,'0')+m[3];
    return s.replace(/[^\d]/g,"");
  }
  function setDisabled(v){ btn.disabled=v; keyEnter.disabled=v; keypad.querySelectorAll('.k').forEach(b=>b.disabled=v); }
  function tryUnlock(){
    if(Date.now()<lockUntil) return;
    const v=normalize(input.value);
    if(v===SECRET){
      err.textContent=""; FX.emit(innerWidth*.5, innerHeight*.7,18);
      showStage("stage-story-a"); location.hash="#stage-story-a";
    }else{
      err.textContent="‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á! (‡πÉ‡∏ö‡πâ: ‡∏ß‡∏±‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô";
      tries++; if(tries>=1){
        const LOCK=10000; lockUntil=Date.now()+LOCK; setDisabled(true);
        let left=10; const old=btn.textContent; btn.textContent=`‡∏•‡πá‡∏≠‡∏Å ${left}s`;
        const t=setInterval(()=>{ left--; btn.textContent = left>0? `‡∏•‡πá‡∏≠‡∏Å ${left}s` : old; if(left<=0){ clearInterval(t); setDisabled(false);} },1000);
      }
    }
  }
  btn.addEventListener("pointerdown", e=>{ e.preventDefault(); e.stopPropagation(); tryUnlock(); });
  keyEnter.addEventListener("pointerdown", e=>{ e.preventDefault(); e.stopPropagation(); tryUnlock(); });
  keypad.addEventListener("pointerdown", e=>{
    const el=e.target.closest(".k"); if(!el) return; e.preventDefault(); e.stopPropagation();
    if(performance.now()-lastKeyAt<70) return; lastKeyAt=performance.now();
    const k=(el.textContent||"").trim(); if(k==='‚å´'){ input.value=input.value.slice(0,-1); } else { input.value+=k; }
  }, {passive:false});
})();

/* ===== Helper ===== */
function countdownAndGo(textEl, nextStageId){
  let left=3; textEl.textContent = `‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÉ‡∏ô ${left} ‡∏ß‡∏¥‚Ä¶`;
  const iv=setInterval(()=>{ left--; textEl.textContent=`‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡πÉ‡∏ô ${left} ‡∏ß‡∏¥‚Ä¶`; if(left<=0){ clearInterval(iv); textEl.textContent=""; showStage(nextStageId); } },1000);
}
function typeText(el,text){ if(!el) return; el.textContent=""; let i=0; (function step(){ if(i<text.length){ el.textContent+=text[i++]; requestAnimationFrame(step);} })(); }

/* ===== Story A ===== */
(function storyA(){
  typeText($("storyAtext"), SETTINGS.storyA);
  const boxMsg=$("countdownA");
  document.querySelectorAll(".miniA").forEach(btn=>{
    btn.addEventListener("pointerdown", (e)=>{
      e.preventDefault();
      if(btn.dataset.correct==="1"){
        btn.classList.replace("btn-ghost","btn-primary");
        $("quoteA").textContent = SETTINGS.quotesA?.[0]||"";
        document.querySelectorAll(".miniA").forEach(b=>b.disabled=true);
        countdownAndGo(boxMsg, "stage-1");
      }else{
        toast("‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞...ü•∫","warn",2600); document.querySelector(".hintA").classList.remove("hidden");
      }
    }, {once:true});
  });
})();

/* ===== Stage 1 ===== */
(function stage1(){
  const TOTAL=20, HIDDEN=7, symbols=['üåü','‚ú®','üåô','‚≠ê','üí´','üå∏','üå∫','üåª','üå∑','üåπ','ü¶ã','üåà','‚òÄÔ∏è','üåä','üåø','üçÄ','üé≠','üé™','üé®','üéµ'];
  const board=$("board1"), score=$("score1"), cd=$("countdown1"); let targets=[], opened={}, found=0, completed=false;
  function update(){ score.textContent=`Found: ${found}/${HIDDEN}`; }
  function resetBoard(){
    board.innerHTML=""; opened={}; found=0; completed=false; update(); cd.textContent="";
    const arr=Array.from({length:TOTAL},(_,i)=>i).sort(()=>Math.random()-0.5); targets=arr.slice(0,HIDDEN);
    for(let i=0;i<TOTAL;i++){ const t=document.createElement("button"); t.className="tile"; const span=document.createElement("span");
      span.textContent=symbols[i%symbols.length]; t.appendChild(span); t.addEventListener("pointerdown",(e)=>{ e.preventDefault(); clickTile(i,t,span); }); board.appendChild(t);
    }
  }
  function clickTile(i,tile,span){
    if(opened[i]||completed) return; opened[i]=true;
    if(targets.includes(i)){
      tile.classList.add("found"); span.textContent="üíñ"; found++; FX.tiny(tile.getBoundingClientRect().left+30, tile.getBoundingClientRect().top+30);
      update(); if(found===HIDDEN){ completed=true; countdownAndGo(cd, "stage-story-b"); }
    } else {
      tile.animate([{transform:'translateX(0)'},{transform:'translateX(-4px)'},{transform:'translateX(4px)'},{transform:'translateX(0)'}],{duration:200});
    }
  }
  resetBoard();
})();

/* ===== Story B ===== */
(function storyB(){
  typeText($("storyBtext"), SETTINGS.storyB);
  const yes=document.querySelector(".miniB-yes"), no=document.querySelector(".miniB-no"), boxMsg=$("countdownB");
  yes.addEventListener("pointerdown", (e)=>{ e.preventDefault(); yes.classList.add("btn-primary"); yes.disabled=true; no.disabled=true; $("quoteB").textContent=SETTINGS.quotesB?.[0]||""; countdownAndGo(boxMsg, "stage-2"); });
  no.addEventListener("pointerdown", (e)=>{ e.preventDefault(); toast("‡∏¢‡∏±‡∏á‡πÑ‡∏á‡∏ã‡∏∞ ‡πÄ‡∏ò‡∏≠‡∏Å‡πá‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡πâ‡∏≤ üíó","warn",3000); no.remove(); yes.classList.add("btn-primary"); yes.focus(); }, {once:true});
})();

/* ===== Stage 2 (Memory) ===== */
(function stage2(){
  const grid=$("gridMatch"), score=$("score2"), cd=$("countdown2");
  const icons=["üêª","üê±","üê∂","üê∞","ü¶ä","üêº"]; let first=null, lock=false, matched=0, done=false;
  function update(){ score.textContent=`Matched: ${matched}/${icons.length}`; }
  function resetGrid(){
    grid.innerHTML=""; first=null; lock=false; matched=0; done=false; update(); cd.textContent="";
    [...icons,...icons].sort(()=>Math.random()-0.5).forEach(sym=>{
      const c=document.createElement("div"); c.className="card-m"; c.dataset.val=sym;
      const f=document.createElement("div"); f.className="card-face card-front"; f.textContent="‚ùì";
      const b=document.createElement("div"); b.className="card-face card-back"; b.textContent=sym;
      c.appendChild(f); c.appendChild(b);
      c.addEventListener("pointerdown",(e)=>{ e.preventDefault(); flip(c); });
      grid.appendChild(c);
    });
  }
  function flip(card){
    if(lock||card.classList.contains("matched")||card===first||done) return;
    card.classList.add("flip");
    if(!first){ first=card; return; }
    lock=true; const a=first.dataset.val, b=card.dataset.val;
    setTimeout(()=>{ if(a===b){ first.classList.add("matched"); card.classList.add("matched"); matched++; FX.tiny(card.getBoundingClientRect().left+30, card.getBoundingClientRect().top+40); update(); if(matched===icons.length){ done=true; countdownAndGo(cd, "stage-story-c"); } } else { first.classList.remove("flip"); card.classList.remove("flip"); } first=null; lock=false; },380);
  }
  resetGrid();
})();

/* ===== Story C ===== */
(function storyC(){
  typeText($("storyCtext"), SETTINGS.storyC);
  const input=$("answerC"), btn=$("answerCBtn"), cd=$("countdownC"), hint=document.querySelector(".hintC");
  const OK=["‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ü‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡πâ‡∏≤","‡πÅ‡∏ü‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡πâ‡∏≤","‡πÅ‡∏ü‡∏ô‡πÄ‡∏Ñ‡πâ‡∏≤","‡∏™‡∏≤‡∏°‡∏µ‡πÄ‡∏Ñ‡πâ‡∏≤"];
  function pass(v){ v=(v||"").trim().toLowerCase(); return OK.some(a=>v.includes(a.toLowerCase())); }
  btn.addEventListener("pointerdown", (e)=>{ e.preventDefault(); if(pass(input.value)){ input.disabled=true; btn.disabled=true; $("quoteC").textContent=SETTINGS.quotesC?.[0]||""; countdownAndGo(cd, "stage-3"); } else { toast("‡πÉ‡∏ö‡πâ‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‚Äî‡πÄ‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏Ç‡∏≠‡∏á‡πÄ‡∏ò‡∏≠‡∏ô‡πâ‡∏≤?","warn",3000); hint.classList.remove("hidden"); input.focus(); } });
  input.addEventListener("keydown", e=>{ if(e.key==="Enter") btn.click?.(); });
})();
  /* ===== Stage 3 (Quiz) ===== */
(function stage3(){
  const wrap=$("quiz"), score=$("score3"), needEl=$("needQ"), cd=$("countdown3"); let sel=[];
  function render(){
    wrap.innerHTML="";
    SETTINGS.quiz.forEach((it,qi)=>{
      const q=document.createElement("div"); q.className="q"; const h=document.createElement("h4"); h.textContent=`‡∏Ç‡πâ‡∏≠ ${qi+1}. ${it.q}`;
      const opt=document.createElement("div"); opt.className="opt";
      it.a.forEach((ans,ai)=>{ const b=document.createElement("button"); b.textContent=ans; if(sel[qi]===ai) b.classList.add("selected");
        b.addEventListener("pointerdown", (e)=>{ e.preventDefault(); sel[qi]=ai; render(); update(); });
        opt.appendChild(b);
      });
      q.appendChild(h); q.appendChild(opt); wrap.appendChild(q);
    });
  }
  function update(){
    const total = SETTINGS.quiz.length; needEl.textContent=total;
    const c = SETTINGS.quiz.reduce((acc,it,i)=> acc + (sel[i]===it.correct?1:0),0);
    score.textContent=`Correct: ${c}/${total}`;
    if(c===total){ if(!cd.textContent) countdownAndGo(cd, "stage-4"); } else { cd.textContent=""; }
  }
  sel = new Array(SETTINGS.quiz.length).fill(null); render(); update();
})();

/* ===== Stage 4 (Balloon) ‚Äî Optimized for rapid taps ===== */
(function stage4(){
  const area=$("balloonArea"), needEl=$("needB"), hitEl=$("hitB"), timeEl=$("timeB"), startBtn=$("startB"), resetBtn=$("resetB"), nextBtn=$("nextB"), cd=$("countdownBdone");
  const COLORS=['#ff6b81','#ff9ff3','#feca57','#48dbfb','#1dd1a1','#ff8fa3','#c084fc','#60a5fa'];
  const cfg=SETTINGS.balloon;
  let need, hit, left, ended=false, spawner=null, timer=null, raf=null;
  let nodes=[], objs=[];

  function clearTimers(){ if(spawner) clearInterval(spawner); if(timer) clearInterval(timer); if(raf) cancelAnimationFrame(raf); spawner=timer=raf=null; }
  function resetUI(){ area.innerHTML=""; nodes=[]; objs=[]; hit=0; left=cfg.time; need=cfg.need; needEl.textContent=need; hitEl.textContent=hit; timeEl.textContent=left; nextBtn.classList.add("hidden"); cd.textContent=""; }

  function start(){
    clearTimers(); ended=false; resetUI();
    startBtn.disabled=true; resetBtn.disabled=false; area.style.pointerEvents='auto';
    spawn(); // ‡πÇ‡∏ú‡∏•‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    spawner=setInterval(spawn, cfg.spawnEveryMs);
    timer=setInterval(()=>{ if(ended) return; left--; timeEl.textContent=left; if(left<=0) finish(false); }, 1000);
    let last=performance.now(), H=area.clientHeight, W=area.clientWidth;
    function loop(t){
      const dt=Math.min(48, t-last); last=t;
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡∏•‡∏≠‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô)
      for(let i=objs.length-1;i>=0;i--){
        const o=objs[i], n=nodes[i];
        if(!n) continue;
        o.y -= (H / o.dur) * (dt/1000);
        n.style.transform = `translate(${o.x}px, ${o.y}px)`;
        if(o.y < -120){ n.remove(); nodes.splice(i,1); objs.splice(i,1); }
      }
      if(!ended) raf=requestAnimationFrame(loop);
    }
    raf=requestAnimationFrame(loop);
  }

  function finish(ok){
    if(ended) return; ended=true; clearTimers(); area.style.pointerEvents='none';
    if(ok){ nextBtn.classList.remove("hidden"); cd.textContent="‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å‡∏Ñ‡πà‡∏∞!"; countdownAndGo(cd, "stage-final"); }
    else { cd.textContent="‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞‡∏Ñ‡∏∞ ‚úåÔ∏è"; }
    startBtn.disabled=false;
  }

  function spawn(){
    if(ended) return; if(nodes.length>28) return;
    const wrap=document.createElement("div"); wrap.className="balloonWrap";
    const b=document.createElement("div"); b.className="balloon";
    const size=50+Math.random()*16; b.style.width=size+"px"; b.style.height=(size*1.25)+"px";
    b.style.setProperty('--balloon', COLORS[Math.floor(Math.random()*COLORS.length)]);
    wrap.appendChild(b); area.appendChild(wrap);
    const H=area.clientHeight, W=area.clientWidth;
    const x = 20 + Math.random()*(W-40);
    const dur = cfg.minDur + Math.random()*(cfg.maxDur-cfg.minDur);
    const yStart = H + 60;
    nodes.push(wrap); objs.push({x:x, y:yStart, dur:dur});
    wrap.style.transform = `translate(${x}px, ${yStart}px)`;

    // ‡πÄ‡∏ö‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏≠‡∏ô‡∏à‡∏¥‡πâ‡∏°: ‡∏Å‡∏±‡∏ô event global + ‡πÉ‡∏ä‡πâ FX.tiny ‡πÅ‡∏ó‡∏ô FX.emit
    b.addEventListener("pointerdown", ev=>{
      ev.preventDefault(); ev.stopPropagation();
      if(ended) return;
      const rect=area.getBoundingClientRect();
      FX.tiny(ev.clientX??(rect.left+x), ev.clientY??(rect.top+H-10));
      wrap.remove();
      const idx=nodes.indexOf(wrap); if(idx>-1){ nodes.splice(idx,1); objs.splice(idx,1); }
      hit++; hitEl.textContent=hit; if(hit>=need) finish(true);
    }, {once:true});
  }

  startBtn.addEventListener("pointerdown", (e)=>{ e.preventDefault(); start(); });
  resetBtn.addEventListener("pointerdown", (e)=>{ e.preventDefault(); finish(false); start(); });
  nextBtn.addEventListener("pointerdown", (e)=>{ e.preventDefault(); showStage("stage-final"); });

  addEventListener("hashchange", ()=>{ if(location.hash!=='#stage-4'){ clearTimers(); area.innerHTML=""; nodes=[]; objs=[]; } });
})();

/* ===== Final ===== */
(function finalStage(){
  const trigger=$("envelope"), modal=$("envModal"), close=$("closeEnv");
  trigger.addEventListener("pointerdown", e=>{ e.preventDefault(); modal.classList.add("open"); });
  close.addEventListener("pointerdown", e=>{ e.preventDefault(); modal.classList.remove("open"); });
  modal.addEventListener("pointerdown", e=>{ if(e.target===modal) modal.classList.remove("open"); });

  $("giftBtn").addEventListener("pointerdown", e=>{ e.preventDefault(); FX.emit(innerWidth*.5, innerHeight*.6,18); $("giftMsg").textContent="‡∏à‡∏∏‡πâ‡∏ö‡πÅ‡∏Å‡πâ‡∏°‡∏°‡∏∞‡∏°‡∏¥‡πä ‡∏°‡∏∞‡∏°‡∏¥‡πä‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å‡πÜ‡πÄ‡∏•‡∏¢ ‡πÄ‡∏Ñ‡πâ‡∏≤‡∏£‡∏±‡∏Å‡∏°‡∏∞‡∏°‡∏¥‡πä‡∏°‡∏≤‡∏Å ‡πÜ ‡∏Ñ‡πà‡∏∞ üíû"; });

  const coupons=["‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏î‡πá‡∏Å‡∏î‡∏µ‡πÑ‡∏°‡πà‡∏î‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏ò‡∏≠ 3 ‡∏ß‡∏±‡∏ô","‡∏≠‡πâ‡∏≠‡∏ô‡πÄ‡∏ò‡∏≠‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡πÜ","‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡∏Å‡∏±‡∏ö‡πÄ‡∏ò‡∏≠ 20 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á","‡∏à‡∏∏‡πâ‡∏ö‡πÅ‡∏Å‡πâ‡∏°‡πÄ‡∏ò‡∏≠ 100 ‡∏ó‡∏µ","‡∏ö‡∏≠‡∏Å‡∏£‡∏±‡∏Å‡πÄ‡∏ò‡∏≠ 100 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á","‡∏ô‡∏ß‡∏î‡πÑ‡∏´‡∏•‡πà 30 ‡∏ô‡∏≤‡∏ó‡∏µ","‡∏ï‡∏≤‡∏°‡πÉ‡∏à‡πÄ‡∏ò‡∏≠ 1 ‡∏Ç‡πâ‡∏≠","‡∏î‡∏π‡∏´‡∏ô‡∏±‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô","‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î‡∏ï‡∏ö 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á","‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏≠‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏ò‡∏≠"];
  const roll=$("couponRoll"), btn=$("couponBtn"); let rolling=false;
  btn.addEventListener("pointerdown", e=>{
    e.preventDefault();
    if(rolling) return; rolling=true; btn.disabled=true; let t=0; const total=1500, step=90;
    const loop=setInterval(()=>{ roll.textContent="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏∏‡πà‡∏°‚Ä¶ "+coupons[Math.floor(Math.random()*coupons.length)]; t+=step;
      if(t>=total){ clearInterval(loop); const pick=coupons[Math.floor(Math.random()*coupons.length)];
        roll.textContent="‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤: "+pick; rolling=false; btn.disabled=false; FX.emit(innerWidth*.5, innerHeight*.7,12);
      }
    }, step);
  });

  $("burstFinal").addEventListener("pointerdown", e=>{ e.preventDefault(); FX.emit(innerWidth*.5, innerHeight*.65,16); });
  $("copyLink").addEventListener("pointerdown", async e=>{
    e.preventDefault();
    const data={title:"Love Stages", text:"‡∏•‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏î‡∏π‡∏ô‡πâ‡∏≤ üíñ", url:location.href};
    try{ if(navigator.share){ await navigator.share(data); toast("‡πÅ‡∏ä‡∏£‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏ò‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‚ú®","ok",2600); return; } }catch(e){}
    await navigator.clipboard?.writeText(data.url); toast("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß","ok",2400);
  });
})();

/* Router init */
addEventListener("load", ()=>{ const h=location.hash.replace("#",""); showStage(STAGES.includes(h)?h:"stage-gate"); });
addEventListener("hashchange", ()=>{ const h=location.hash.replace("#",""); if(STAGES.includes(h)) showStage(h); });
</script>
</body>
</html>
